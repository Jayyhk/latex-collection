\chapter{Framed Theorems and Exercises}
\label{chap:box}

\paragraph{Introduction}
This chapter touches on how to make beautiful, colored frames around theorems, examples, and so on. The typesetting and management of exercises and answers will also be discussed. 

\section{Colored Boxes for Theorems and Proofs}
\label{sec:colorbox}

\paragraph{Making Colored Boxes}
We will start by generating a simple colored box first, which is most easily done by importing the \texttt{tcolorbox}\index{tcolorbox@\texttt{tcolorbox}} package. Then we can define the design of the box by the \texttt{\textbackslash newtcolorbox}\index{newtcolorbox@\texttt{\textbackslash newtcolorbox}} command. An illustrative template is
\begin{lstlisting}
\newtcolorbox{mybox}[1][]{
  colback=Green!20, 
  colframe=Gray,
  coltitle=Yellow,
  title=This is my box,
  boxrule=1pt,
  leftrule=1ex,
  boxsep=1ex,
  left=1ex,
  right=1ex,
  sharp corners,
  breakable,
  before skip=\topsep,
  after skip=\topsep, #1}
\end{lstlisting}
that creates a box environment named \texttt{mybox}. Then typing
\begin{lstlisting}
\begin{mybox}
The content goes here.
\end{mybox}    
\end{lstlisting}
produces the following box:
\begin{mybox}
The content goes here.
\end{mybox}
\texttt{colback}\index{colback@\texttt{colback}}, \texttt{colframe}\index{colframe@\texttt{colframe}}, and \texttt{coltitle}\index{coltitle@\texttt{coltitle}} denote the color of the background, frame, and title, correspondingly. \texttt{boxrule}\index{boxrule@\texttt{boxrule}} (\texttt{leftrule}) is the width of bounding lines (at the left), and \texttt{boxsep}\index{boxsep@\texttt{boxsep}} indicates the overall padding around the title and content. \texttt{left}/\texttt{right} further refines the padding to the left/right. The meanings of the \texttt{sharp corners} and \texttt{breakable}\index{breakable@\texttt{breakable}} keywords are not hard to guess: the box will have sharp corners instead of rounded ones, and it can break across pages. Finally, \texttt{before skip} and \texttt{after skip} indicate the vertical spacing to other objects before and after the entire box. The \texttt{[1][]} part is added so that the box can receive an optional argument, which can override the given setting of the box via putting \texttt{\#1} at the end of the \texttt{\textbackslash newtcolorbox} option list. 

\paragraph{Colored Numbered Theorems/Examples}
The readers are probably concerned more about how to construct a colored, numbered box for theorems, examples, definitions, and the like. This requires us to pass
\begin{lstlisting}
\tcbuselibrary{theorems}
\end{lstlisting}
and then we can use the \texttt{\textbackslash newtcbtheorem[<init>]\{<name>\}\{<display\_\allowbreak name>\}\{<options>\}\{<prefix>\}}\index{newtcbtheorem@\texttt{\textbackslash newtcbtheorem}} construct. The \texttt{init} part sets up the way of numbering (e.g.\ 5.1 vs 5.1.1), the \texttt{name} is referred to when an instance of the box environment has to be made, while the \texttt{options} part is just like the previous input lists for \texttt{\textbackslash newtcolorbox}. For example, we can define
\begin{lstlisting}
\newtcbtheorem[number within=chapter]{thm}{Theorem}{
  colback=Green!20,
  colframe=Green!50,
  fonttitle=\bfseries,
  boxrule=1pt,
  boxsep=1ex,
  left=1ex,
  right=1ex,
  pad after break=1.5ex,
  sharp corners,
  breakable,
  before skip=\topsep,
  after skip=\topsep}{thm}
\end{lstlisting}
where we have added some new parameters: \texttt{fonttitle}\index{fonttitle@\texttt{fonttitle}} here indicates the title to be in boldface, and \texttt{pad after break}\index{pad after break@\texttt{pad after break}} adds some padding after the box breaks across the page. The \texttt{number within=chapter}\index{number within@\texttt{number within}} option tells the numbering to be based on chapters, and it can be changed to, e.g.\ \texttt{section}. Subsequently, writing
\begin{lstlisting}
\begin{thm}{Mean Value Theorem}{mvt}
If ...
\begin{equation}
f'(c) = \frac{f(b)-f(a)}{b-a}
\end{equation}
\end{thm}
\end{lstlisting}
produces
\begin{thm}{Mean Value Theorem}{mvt}
If $f(x)$ is continuous on $[a,b]$ and differentiable on $(a,b)$, then there exists $c \in (a,b)$ such that
\begin{equation}
f'(c) = \frac{f(b)-f(a)}{b-a}
\end{equation}
\end{thm}
We can refer to this theorem as Theorem \ref{thm:mvt} by \texttt{\textbackslash ref\{thm:mvt\}} (\texttt{prefix:\allowbreak alias}). It is also possible to supply additional options to override the base setting of the colored box.

\paragraph{Shared Numbering for Definitions and the Others}
Another feature that may be useful is to enable \textit{shared numbering}\index{Shared Numbering} for definitions, lemmas, corollaries, properties, and so on. To do so, we can invoke the \texttt{\textbackslash newtcbtheorem} command again and pass the keyword \texttt{use counter from=}\index{use counter from@\texttt{use counter from}} for the \texttt{init} option:
\begin{lstlisting}
\tcbset{mycommon/.style={
  colback=Green!20,
  colframe=Green!50,
  fonttitle=\bfseries,
  coltitle=black,
  theorem style=plain,
  ...}
}
\newtcbtheorem[use counter from=thm]{defn}{Definition}{mycommon}{defn}
\end{lstlisting}
Here we use \texttt{\textbackslash tcbset}\index{tcbset@\texttt{\textbackslash tcbset}} to save the style with the name \texttt{mycommon} for repeated use. Then
\begin{lstlisting}
\begin{defn}{Taylor Expansion}{taylor}
For a function $f(x)$ infinitely differentiable at point $x = a$, we have its Taylor series as
\begin{equation}
f(x) = f(a) + \frac{f'(a)}{1!}(x-a) + \frac{f''(a)}{2!}(x-a)^2 + \frac{f'''(a)}{3!}(x-a)^3 + \cdots 
\end{equation}
\end{defn}
\end{lstlisting}
is rendered as
\begin{defn}{Taylor Expansion}{taylor}
For a function $f(x)$ infinitely differentiable at point $x = a$, we have its Taylor series as
\begin{equation}
f(x) = f(a) + \frac{f'(a)}{1!}(x-a) + \frac{f''(a)}{2!}(x-a)^2 + \frac{f'''(a)}{3!}(x-a)^3 + \cdots 
\end{equation}
\end{defn}
Notice that we have set \texttt{theorem style=plain} (there are more possible values, like \texttt{break}), see if you can figure out where the difference is.

\paragraph{Proofs} For proofs or worked steps, their setting will often be slightly different. We can load the \texttt{amsthm}\index{amsthm@\texttt{amsthm}} package, which comes along with the \texttt{proof}\index{proof@\texttt{proof}} environment, and apply \texttt{\textbackslash tcolorboxenvironment}\index{tcolorboxenvironment@\texttt{\textbackslash tcolorboxenvironment}} on it. The template will be
\begin{lstlisting}
\tcolorboxenvironment{proof}{
  blank,
  breakable,
  borderline west={0.5ex}{2pt}{black},
  left=2ex,
  before skip=\topsep,
  after skip=\topsep} 
\end{lstlisting}
The \texttt{blank} keyword initializes just the frame, and the \texttt{borderline west} option draws a long black line to the left. Then, writing
\begin{lstlisting}
\begin{proof}
Consider $\vec{w} = \vec{u} + t\vec{v}$, ...
\begin{align*}
\Delta = b^2 - 4ac &\leq 0 \\
(2(\vec{u} \cdot \vec{v}))^2 - 4\norm{\vec{u}}^2\norm{\vec{v}}^2 &\leq 0 \\
(\vec{u} \cdot \vec{v})^2 - \norm{\vec{u}}^2\norm{\vec{v}}^2 &\leq 0 \\
(\vec{u} \cdot \vec{v})^2 &\leq \norm{\vec{u}}^2\norm{\vec{v}}^2 \\
|\vec{u} \cdot \vec{v}| &\leq \norm{\vec{u}}\norm{\vec{v}} \qedhere % putting \qedhere to eliminate the spurious gap
\end{align*}
\end{proof}
\end{lstlisting}
results in
\begin{proof}
Consider $\vec{w} = \vec{u} + t\vec{v}$, where $t$ is any scalar, then $\norm{\vec{w}}^2 = \vec{w}\cdot\vec{w} \geq 0$ by positivity. Also, $\vec{w}\cdot\vec{w}$ can be written as a quadratic polynomial in $t$:
\begin{align*}
\vec{w}\cdot\vec{w} = (\vec{u} + t\vec{v}) \cdot (\vec{u} + t\vec{v}) = \norm{\vec{u}}^2 + 2t(\vec{u} \cdot \vec{v}) + t^2\norm{\vec{v}}^2
\end{align*}
Since this quantity is always greater than or equal to zero, i.e.\ the quadratic polynomial has no root or a repeated root, it means that the discriminant must be negative or zero. So,
\begin{align*}
\Delta = b^2 - 4ac &\leq 0 \\
(2(\vec{u} \cdot \vec{v}))^2 - 4\norm{\vec{u}}^2\norm{\vec{v}}^2 &\leq 0 \\
(\vec{u} \cdot \vec{v})^2 - \norm{\vec{u}}^2\norm{\vec{v}}^2 &\leq 0 \\
(\vec{u} \cdot \vec{v})^2 &\leq \norm{\vec{u}}^2\norm{\vec{v}}^2 \\
|\vec{u} \cdot \vec{v}| &\leq \norm{\vec{u}}\norm{\vec{v}} \qedhere
\end{align*}
\end{proof}
Moreover, we can copy it with “Proof” replaced by “Solution” as 
\begin{lstlisting}
\newenvironment{solution}{\begin{proof}[Solution]}{\end{proof}}
\end{lstlisting}

\begin{exercisebox}
\begin{Exercise}
\phantomsection%
\label{exer:colorbox}%
Design your own color box to display any example problem, followed by a worked solution.
\end{Exercise}
\end{exercisebox}

\section{Typesetting Exercises and Answers}

\paragraph{Exercises}
The essence of any math book is its \textit{exercises}\index{Exercise}. To deliver exercises and their solutions, we can import the \texttt{exercise}\index{exercise@\texttt{exercise}} package with the following options (to be explained soon):
\begin{lstlisting}
\usepackage[lastexercise,answerdelayed]{exercise}
\end{lstlisting}
Then we can typeset any exercise within the \texttt{Exercise}\index{Exercise@\texttt{Exercise}} environment, which we have been doing for a long time. As an example, the last exercise was created by
\begin{lstlisting}
\begin{exercisebox}
\begin{Exercise}
\phantomsection%
\label{exer:colorbox}%
Design your own color box to display any example problem, followed by a worked solution.
\end{Exercise}
\end{exercisebox}
\end{lstlisting}
where \texttt{exercisebox} here is a self-defined\footnote{The actual implementation can be checked from my raw source code.} colored box environment generated by \texttt{\textbackslash newtcolorbox} as introduced in the last section. We can refer to this exercise as Exercise \ref{exer:colorbox} via its label \texttt{\textbackslash ref\{exer:colorbox\}}. As an extra note, to ensure the internal referencing link to the exercise is correct, we need a patch by inserting \texttt{\textbackslash phantomsection}\index{phantomsection@\texttt{\textbackslash phantomsection}} at its start before \texttt{label}.

\paragraph{Headers for Exercises}
We may also want to change the format of the headers for exercises. This can be done by applying \texttt{\textbackslash renewcommand*} to the \texttt{\textbackslash theExercise}\index{theExercise@\texttt{\textbackslash theExercise}} and \texttt{\textbackslash ExerciseHeader}\index{ExerciseHeader@\texttt{\textbackslash ExerciseHeader}} commands as follows: 
\begin{lstlisting}
\renewcounter{Exercise}[chapter]
\renewcommand*{\theExercise}{\thechapter.\arabic{Exercise}}
\renewcommand*{\ExerciseHeader}{\textbf{\theExercise )}}
\renewcommand*{\ExerciseSkipBefore}{\dimexpr.5\baselineskip}
\renewcommand*{\ExerciseSkipAfter}{\dimexpr.5\baselineskip}
\end{lstlisting}
The very first \texttt{\textbackslash renewcounter\{<counter\_name>\}[]}\index{renewcounter@\texttt{\textbackslash renewcounter}} command is used to reset the exercise counter every time a new chapter starts. Then, the chapter number and boldface are added to the exercise numbering format. Finally, the last two lines adjust the vertical skip before and after each exercise instance.

\paragraph{Answers}
To typeset the answer for an exercise, we can use the \texttt{Answer}\index{Answer@\texttt{Answer}} environment supplied with the corresponding label of that exercise to the \texttt{ref} option. Here we will take Exercise \ref{exer:modulo} as a demonstration, where we can write
\begin{lstlisting}
\begin{Exercise}
\phantomsection%
\label{exer:modulo}%
... % the exercise
\end{Exercise}
\begin{Answer}[ref=exer:modulo]
... % the answer goes here
\end{Answer}
\end{lstlisting}
Alternatively, one can omit the \texttt{ref} part if the \texttt{lastexercise}\index{lastexercise@\texttt{lastexercise}} option has been ticked when importing the package. It assumes that the answer is for the latest exercise, and hence, we can type it immediately after that exercise.

The \texttt{answerdelayed}\index{answerdelayed@\texttt{answerdelayed}} option saves all the answers until the end, and we can output all of them for once by \texttt{\textbackslash shipoutAnswer}\index{shipoutAnswer@\texttt{\textbackslash shipoutAnswer}}. You should be able to see the answers for Exercise \ref{exer:modulo} and others at the end of the book. The detailed code for the answer section of this book is
\begin{lstlisting}
\chapter*{Answers to Exercises}
\ohead{Answers to Exercises}
\addcontentsline{toc}{chapter}{Answers to Exercises}
\shipoutAnswer
\end{lstlisting}

\paragraph{Headers for Answers} The default headers for answers may be too plain. To customize them, we can use the solution proposed in \href{https://tex.stackexchange.com/questions/369265/math-book-how-to-write-exercise-and-answers}{\TeX{} StackExchange 369265} which involves declaring a boolean variable \texttt{firstanswerofthechapter} by \texttt{\textbackslash newboolean}\index{newboolean@\texttt{\textbackslash newboolean}} in the \texttt{ifthen} package. A minimal version is
\begin{lstlisting}
\newboolean{firstanswerofthechapter}  
\renewcommand*{\AnswerHeader}{\ifthenelse{\boolean{firstanswerofthechapter}}
    {\textbf{Answers for Chapter \thechapter}\par\vspace{1ex}%
     \theExercise)}
    {\theExercise)}
}
\end{lstlisting}
This updates the \texttt{\textbackslash AnswerHeader}\index{AnswerHeader@\texttt{\textbackslash AnswerHeader}} command with an if-then-else statement. Then, we can call \texttt{\textbackslash setboolean\{firstanswerofthechapter\}\{true\}} whenever we are at the first answer in a chapter, then \texttt{\textbackslash AnswerHeader} will first print the heading “Answers for Chapter \texttt{\textbackslash thechapter}” where \texttt{\textbackslash thechapter} is the chapter counter, and proceed to print the exercise number stored by \texttt{\textbackslash theExercise} with a round bracket to the right. Afterwards, reset \texttt{\textbackslash setboolean\{first\allowbreak answerofthechapter\}\{false\}} and the \texttt{\textbackslash AnswerHeader} will just consist of the exercise number.